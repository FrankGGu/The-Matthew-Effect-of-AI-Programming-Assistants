(define (k-smallest-pairs nums1 nums2 k)
  (let* ((len1 (length nums1))
         (len2 (length nums2))
    (if (or (zero? len1) (zero? len2))
        '()
        (let ((heap (make-heap (lambda (a b) (< (+ (car a) (cadr a)) (+ (car b) (cadr b)))))))
          (heap-add! heap (list (first nums1) (first nums2) 0 0))
          (let loop ((res '())
                     (k (min k (* len1 len2))))
            (if (zero? k)
                (reverse res)
                (let* ((top (heap-remove! heap))
                       (i (caddr top))
                       (j (cadddr top))
                       (next-i (add1 i))
                       (next-j (add1 j)))
                  (when (and (< next-i len1) (= j 0))
                    (heap-add! heap (list (list-ref nums1 next-i) (list-ref nums2 j) next-i j)))
                  (when (< next-j len2)
                    (heap-add! heap (list (list-ref nums1 i) (list-ref nums2 next-j) i next-j)))
                  (loop (cons (list (car top) (cadr top)) res) (sub1 k)))))))))