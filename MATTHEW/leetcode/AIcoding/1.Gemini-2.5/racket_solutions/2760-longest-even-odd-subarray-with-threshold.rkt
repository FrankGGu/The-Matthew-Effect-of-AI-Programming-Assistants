(define (longest-even-odd-subarray-with-threshold nums threshold)
  (let* ((n (vector-length nums))
         (max-len 0))
    (for ((i (in-range n)))
      (when (and (<= (vector-ref nums i) threshold)
                 (= (modulo (vector-ref nums i) 2) 0))
        (let loop ((j (+ i 1))
                   (current-len 1))
          (if (and (< j n)
                   (<= (vector-ref nums j) threshold)
                   (not (= (modulo (vector-ref nums j) 2)
                           (modulo (vector-ref nums (- j 1)) 2))))
              (loop (+ j 1) (+ current-len 1))
              (set! max-len (max max-len current-len))))))
    max-len))