(define-struct Node (val left right next) #:mutable)

(define (connect root)
  (when (not (null? root))
    (let loop ((level-start root))
      (when (not (null? level-start))
        (let ((dummy-head (Node 0 null null null)))
          (let ((prev-ref (box dummy-head)))
            (let process-current-level ((curr level-start))
              (when (not (null? curr))
                (when (not (null? (Node-left curr)))
                  (set-Node-next! (unbox prev-ref) (Node-left curr))
                  (set-box! prev-ref (Node-left curr)))
                (when (not (null? (Node-right curr)))
                  (set-Node-next! (unbox prev-ref) (Node-right curr))
                  (set-box! prev-ref (Node-right curr)))
                (process-current-level (Node-next curr))))
            (loop (Node-next (unbox dummy-head))))))))
  root)