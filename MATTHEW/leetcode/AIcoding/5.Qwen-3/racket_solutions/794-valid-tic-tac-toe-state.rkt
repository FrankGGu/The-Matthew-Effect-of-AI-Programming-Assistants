(define (valid-tic-tac-toe-state board)
  (define (count player)
    (for*/sum ([row board] [cell row])
      (if (equal? cell player) 1 0)))
  (define x (count "X"))
  (define o (count "O"))
  (if (or (> x o) (< x o))
      #f
      (let ([win-x (or (and (= x o) (not (win? "O" board))) (win? "X" board))]
            [win-o (or (and (= x o) (not (win? "X" board))) (win? "O" board))])
        (and (not (and win-x win-o)) (or win-x win-o)))))

(define (win? player board)
  (define (check line)
    (and (equal? (car line) player)
         (equal? (cadr line) player)
         (equal? (caddr line) player)))
  (or (check (list-ref board 0))
      (check (list-ref board 1))
      (check (list-ref board 2))
      (check (list (list-ref (list-ref board 0) 0)
                   (list-ref (list-ref board 1) 1)
                   (list-ref (list-ref board 2) 2)))
      (check (list (list-ref (list-ref board 0) 2)
                   (list-ref (list-ref board 1) 1)
                   (list-ref (list-ref board 2) 0)))
      (check (list (list-ref (list-ref board 0) 0)
                   (list-ref (list-ref board 1) 0)
                   (list-ref (list-ref board 2) 0)))
      (check (list (list-ref (list-ref board 0) 1)
                   (list-ref (list-ref board 1) 1)
                   (list-ref (list-ref board 2) 1)))
      (check (list (list-ref (list-ref board 0) 2)
                   (list-ref (list-ref board 1) 2)
                   (list-ref (list-ref board 2) 2)))))