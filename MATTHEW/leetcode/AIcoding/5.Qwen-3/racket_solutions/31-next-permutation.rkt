(define (next-permutation nums)
  (define len (length nums))
  (define i (- len 2))
  (define j (- len 1))
  (define k (- len 1))
  (let loop ()
    (when (and (>= i 0) (<= (list-ref nums i) (list-ref nums (+ i 1))))
      (set! i (- i 1)))
    (when (>= i 0)
      (let loop2 ()
        (when (<= (list-ref nums k) (list-ref nums i))
          (set! k (- k 1)))
        (when (<= (list-ref nums k) (list-ref nums i))
          (loop2)))
      (let swap ()
        (let ((temp (list-ref nums i)))
          (set! nums (replace-at nums i (list-ref nums k)))
          (set! nums (replace-at nums k temp))))
      (set! nums (reverse (take nums (+ i 1)) (reverse (drop nums (+ i 1)))))
      (void))
    (when (< i 0)
      (set! nums (reverse nums))))
  nums)

(define (replace-at lst index value)
  (if (= index 0)
      (cons value (cdr lst))
      (cons (car lst) (replace-at (cdr lst) (- index 1) value))))

(define (take lst n)
  (if (or (= n 0) (null? lst))
      '()
      (cons (car lst) (take (cdr lst) (- n 1)))))

(define (drop lst n)
  (if (or (= n 0) (null? lst))
      lst
      (drop (cdr lst) (- n 1))))