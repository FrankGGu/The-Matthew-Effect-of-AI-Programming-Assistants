-module(minimize_malware_spread).
-export([minimize_malware_spread/2]).

minimize_malware_spread(Relations, Initial) ->
    Nodes = lists:seq(0, length(Relations) - 1),
    Graph = build_graph(Relations),
    {Infected, NotInfected} = split_infected_not_infected(Initial, Nodes),
    Results = lists:map(fun(Node) -> count_infected(Graph, Node, Infected) end, NotInfected),
    find_optimal_node(NotInfected, Results).

build_graph(Relations) ->
    lists:foldl(fun({A, B}, Acc) ->
        Acc#{A => lists:usort(lists:append(maps:get(A, Acc, []), [B])),
             B => lists:usort(lists:append(maps:get(B, Acc, []), [A]))}
    end, #{}, Relations).

split_infected_not_infected(Initial, Nodes) ->
    Infected = sets:from_list(Initial),
    NotInfected = sets:to_list(sets:subtract(sets:from_list(Nodes), Infected)),
    {Infected, NotInfected}.

count_infected(Graph, Node, Infected) ->
    Visited = sets:from_list([Node]),
    queue:fold(fun(N, Acc) ->
        case sets:is_element(N, Infected) of
            true -> Acc + 1;
            false -> lists:foldl(fun(Neighbor, A) ->
                case sets:is_element(Neighbor, Acc) of
                    false -> sets:add_element(Neighbor, A);
                    true -> A
                end
            end, Acc, maps:get(N, Graph, []))
        end
    end, Visited, queue:from_list([Node])).

find_optimal_node([], _) -> -1;
find_optimal_node([Node | Rest], [Count | RestCounts]) ->
    case lists:all(fun(C) -> C >= Count end, RestCounts) of
        true -> Node;
        false -> find_optimal_node(Rest, RestCounts)
    end.