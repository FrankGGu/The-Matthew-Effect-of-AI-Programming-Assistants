-module(minimize_malware_spread_ii).
-export([minimize_malware_spread_ii/2]).

minimize_malware_spread_ii(Edges, Initial) ->
    Nodes = lists:seq(0, length(Edges) - 1),
    Graph = build_graph(Edges),
    {InitialSorted, _} = lists:sort(Initial),
    InitialSet = sets:from_list(InitialSorted),
    MalwareNodes = InitialSorted,
    BestNode = -1,
    BestCount = 0,
    lists:foldl(fun(Node, {BestNodeAcc, BestCountAcc}) ->
        if
            sets:is_element(Node, InitialSet) -> {BestNodeAcc, BestCountAcc};
            true ->
                Count = count_infected(Graph, Node, InitialSet),
                if
                    Count < BestCountAcc -> {Node, Count};
                    true -> {BestNodeAcc, BestCountAcc}
                end
        end
    end, {BestNode, BestCount}, Nodes).

build_graph(Edges) ->
    lists:foldl(fun({From, To}, Acc) ->
        Map = maps:get(From, Acc, #{}),
        UpdatedMap = maps:put(To, true, Map),
        maps:put(From, UpdatedMap, Acc)
    end, #{}, Edges).

count_infected(Graph, Start, InitialSet) ->
    Visited = sets:new(),
    queue:fold(fun(Node, Acc) ->
        case sets:is_element(Node, InitialSet) of
            true -> Acc;
            false ->
                NewVisited = sets:add_element(Node, Acc),
                Neighbors = maps:get(Node, Graph, #{}),
                lists:foldl(fun(Neighbor, Acc2) ->
                    if
                        sets:is_element(Neighbor, NewVisited) -> Acc2;
                        true -> queue:in(Neighbor, Acc2)
                    end
                end, NewVisited, maps:keys(Neighbors))
        end
    end, queue:in(Start, sets:new()), Visited).