(define (max-frequency nums k)
  (define (can-make-freq freq)
    (define sum (apply + freq))
    (define target (+ sum k))
    (define needed (map (lambda (x) (- target (* (length freq) x))) freq))
    (and (not (null? needed)) (every? (lambda (x) (>= x 0)) needed)))
  (define sorted-nums (sort nums <))
  (define freq (make-vector 0))
  (for-each (lambda (x) (vector-set! freq x (+ (vector-ref freq x) 1))) sorted-nums)
  (define max-freq (apply max (vector->list freq)))
  (if (can-make-freq (vector->list freq)) 
      max-freq 
      (max (max-frequency (remove (lambda (x) (> (vector-ref freq x) 0)) sorted-nums) k) 
          (max-freq (remove (lambda (x) (> (vector-ref freq x) 0)) sorted-nums) k)))))

(define (maxFrequency nums k)
  (define sorted-nums (sort nums <))
  (define n (length sorted-nums))
  (define left 0)
  (define right 0)
  (define max-freq 0)
  (define current-sum 0)
  (define max-value 0)
  (while (< right n)
    (set! current-sum (+ current-sum (vector-ref sorted-nums right)))
    (set! max-value (max max-value (vector-ref sorted-nums right)))
    (while (<= (+ current-sum (- (* (+ 1 (- right left)) max-value)) k) 0)
      (set! current-sum (- current-sum (vector-ref sorted-nums left)))
      (set! left (+ left 1)))
    (set! max-freq (max max-freq (- (+ right 1) left)))
    (set! right (+ right 1)))
  max-freq)