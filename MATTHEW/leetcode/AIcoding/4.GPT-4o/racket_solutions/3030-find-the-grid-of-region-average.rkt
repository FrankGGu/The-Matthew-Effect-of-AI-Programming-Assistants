(define (find-grid-average grid)
  (define n (vector-length grid))
  (define m (vector-length (vector-ref grid 0)))
  (define (in-bounds? x y)
    (and (>= x 0) (< x n) (>= y 0) (< y m)))
  (define (get-sum-and-count x y)
    (let loop ((dx -1) (dy -1) (sum 0) (count 0))
      (if (and (>= dx 2) (>= dy 2))
          (values sum count)
          (let* ((nx (+ x dx))
                 (ny (+ y dy)))
            (if (in-bounds? nx ny)
                (loop (if (= dy 1) (+ dx 1) dx)
                      (if (= dy 1) -1 (+ dy 1))
                      (+ sum (vector-ref (vector-ref grid nx) ny))
                      (+ count 1))
                (if (= dy 1)
                    (loop (+ dx 1) -1 sum count)
                    (loop dx 0 sum count)))))))
  (define result (make-vector n (make-vector m 0)))
  (for ([i (in-range n)] [j (in-range m)])
    (define-values (sum count) (get-sum-and-count i j))
    (vector-set! (vector-ref result i) j (/ sum count)))
  result)