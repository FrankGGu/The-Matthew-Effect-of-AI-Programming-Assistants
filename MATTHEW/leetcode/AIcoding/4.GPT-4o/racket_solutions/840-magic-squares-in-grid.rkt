(define (numMagicSquaresInside grid)
  (define (is-magic-square square)
    (let ([s (apply + (map car square))])
      (and (= s (apply + (map cadr square)))
           (= s (apply + (map caddr square)))
           (= s (+ (car (list-ref square 0)) (caddr (list-ref square 1)) (caddr (list-ref square 2))))
           (= s (+ (caddr (list-ref square 0)) (cadr (list-ref square 1)) (car (list-ref square 2))))
           (equal? (sort (apply append square) <) '(1 2 3 4 5 6 7 8 9)))))

  (define (get-square i j)
    (list (list (list-ref (list-ref grid i) j)
                (list-ref (list-ref grid i) (+ j 1))
                (list-ref (list-ref grid i) (+ j 2)))
          (list (list-ref (list-ref grid (+ i 1)) j)
                (list-ref (list-ref grid (+ i 1)) (+ j 1))
                (list-ref (list-ref grid (+ i 1)) (+ j 2)))
          (list (list-ref (list-ref grid (+ i 2)) j)
                (list-ref (list-ref grid (+ i 2)) (+ j 1))
                (list-ref (list-ref grid (+ i 2)) (+ j 2)))))

  (define count 0)
  (for ([i (in-range 0 (- (length grid) 2))])
    (for ([j (in-range 0 (- (length (list-ref grid 0)) 2))])
      (when (is-magic-square (get-square i j))
        (set! count (+ count 1)))))
  count)