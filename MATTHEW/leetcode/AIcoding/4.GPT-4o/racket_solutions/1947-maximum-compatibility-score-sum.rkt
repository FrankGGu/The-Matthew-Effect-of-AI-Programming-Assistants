(define (compatibility-score sum)
  (define (calc-score student-a student-b)
    (apply + (map (lambda (x y) (if (= x y) 1 0)) student-a student-b)))
  (define (backtrack i selected)
    (if (= i (length sum))
        (if (= (length selected) (/ (length sum) 2)) 
            (apply + (map (lambda (pair) (calc-score (list-ref sum (car pair)) (list-ref sum (cadr pair)))) (combinations (range 0 (length sum)) 2)))
            0)
        (max (backtrack (+ i 1) selected)
             (backtrack (+ i 1) (cons i selected)))))
  (backtrack 0 '()))

(define (maximum-compatibility-score-sum students)
  (compatibility-score students))