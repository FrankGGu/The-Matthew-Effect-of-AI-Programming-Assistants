(define (basic-calculator-iv expression evalvars evalints)
  (define eval-map (foldl (lambda (x acc) (hash-set! acc (car x) (cadr x))) (make-hash) (map list evalvars evalints)))
  (define (parse-expr expr)
    (define tokens (string-split expr #\Space))
    (define op-precedence (hash '() 0 '() 1 '() 1 '() 2))
    (define (shunting-yard tokens)
      (define output '())
      (define operators '())
      (for-each (lambda (token)
                  (cond
                    ((string->number token) (set! output (cons (string->number token) output)))
                    ((hash-has? op-precedence token)
                     (begin
                       (while (and (not (null? operators))
                                   (>= (hash-ref op-precedence (car operators) -1)
                                       (hash-ref op-precedence token -1)))
                         (set! output (cons (car operators) output))
                         (set! operators (cdr operators)))
                       (set! operators (cons token operators)))
                    ((equal? token "(") (set! operators (cons token operators)))
                    ((equal? token ")")
                     (begin
                       (while (not (equal? (car operators) "("))
                         (set! output (cons (car operators) output))
                         (set! operators (cdr operators)))
                       (set! operators (cdr operators))))))
                tokens)
      (while (not (null? operators))
        (set! output (cons (car operators) output))
        (set! operators (cdr operators)))
      (reverse output))
  (define (evaluate tokens)
    (define stack '())
    (for-each (lambda (token)
                (if (number? token)
                    (set! stack (cons token stack))
                    (let ((b (car stack))
                          (a (cadr stack)))
                      (set! stack (cdr (cdr stack)))
                      (set! stack (cons (case token
                                          ((+) (+ a b))
                                          ((-) (- a b))
                                          ((*) (* a b))
                                          ((/) (if (zero? b) 0 (/ a b)))
                                          (else (error "Invalid operator"))) stack)))))
              tokens)
    (car stack))
  (define parsed-expr (shunting-yard (parse-expr expression)))
  (evaluate parsed-expr))

(define (basicCalculatorIV expression evalvars evalints)
  (basic-calculator-iv expression evalvars evalints))