(define (longest-valid-substring s)
  (define (valid? s)
    (let loop ((stack '()) (i 0))
      (cond ((= i (string-length s)) #t)
            ((char=? #\() (loop (cons #\() stack) (+ i 1)))
            ((and (not (null? stack)) (char=? (car stack) #\())))
             (loop (cdr stack) (+ i 1)))
            (else #f))))
  (define (helper s)
    (let loop ((start 0) (end 0) (max-len 0))
      (if (>= end (string-length s))
          max-len
          (let ((new-end (+ end 1)))
            (if (valid? (substring s start new-end))
                (loop start new-end (max max-len (- new-end start)))
                (loop (+ start 1) new-end max-len))))))
  (helper s))