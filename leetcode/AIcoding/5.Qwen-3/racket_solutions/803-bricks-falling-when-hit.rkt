#lang racket

(define (bricks-falling-when-hit grid hits)
  (define rows (length grid))
  (define cols (if (null? grid) 0 (length (car grid))))
  (define visited (make-vector rows (make-vector cols #f)))
  (define (is-valid r c)
    (and (>= r 0) (< r rows) (>= c 0) (< c cols)))
  (define (dfs r c)
    (when (and (is-valid r c) (not (vector-ref (vector-ref visited r) c)) (equal? (vector-ref (vector-ref grid r) c) 1))
      (vector-set! (vector-ref visited r) c #t)
      (for-each (lambda (dr dc)
                  (dfs (+ r dr) (+ c dc)))
                '((0 1) (1 0) (0 -1) (-1 0)))))
  (for-each (lambda (hit)
              (let ((r (car hit)) (c (cadr hit)))
                (vector-set! (vector-ref grid r) c 0)))
            hits)
  (for-each (lambda (r)
              (when (equal? (vector-ref (vector-ref grid r) 0) 1)
                (dfs r 0)))
            (range rows))
  (for-each (lambda (r)
              (when (equal? (vector-ref (vector-ref grid r) (- cols 1)) 1)
                (dfs r (- cols 1))))
            (range rows))
  (for-each (lambda (c)
              (when (equal? (vector-ref (vector-ref grid 0) c) 1)
                (dfs 0 c)))
            (range cols))
  (for-each (lambda (c)
              (when (equal? (vector-ref (vector-ref grid (- rows 1)) c) 1)
                (dfs (- rows 1) c)))
            (range cols))
  (define result '())
  (for-each (lambda (hit)
              (let ((r (car hit)) (c (cadr hit)))
                (vector-set! (vector-ref grid r) c 1)
                (define count 0)
                (when (and (is-valid r c) (equal? (vector-ref (vector-ref grid r) c) 1))
                  (vector-set! (vector-ref visited r) c #f)
                  (dfs r c)
                  (set! count (apply + (map (lambda (i)
                                              (apply + (map (lambda (j)
                                                             (if (vector-ref (vector-ref visited i) j) 1 0))
                                                           (range cols))))
                                            (range rows)))))
                (set! count (- count (apply + (map (lambda (i)
                                                   (apply + (map (lambda (j)
                                                                  (if (vector-ref (vector-ref visited i) j) 1 0))
                                                               (range cols))))
                                             (range rows)))))
                (set! result (cons count result))
                (vector-set! (vector-ref grid r) c 0)))
            hits)
  (reverse result))