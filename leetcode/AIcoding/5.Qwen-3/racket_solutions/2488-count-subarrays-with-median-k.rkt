#lang racket

(define (count-subarrays nums k)
  (define target (car (filter (lambda (x) (= x k)) nums)))
  (define index (for/first ([i (in-range (length nums))] [x nums] #:when (= x target)) i))
  (define n (length nums))
  (define cnt (make-hash))
  (hash-set! cnt 0 1)
  (define res 0)
  (define balance 0)
  (for ([i (in-range n)])
    (when (< i index)
      (if (> (list-ref nums i) target)
          (set! balance (+ balance 1))
          (set! balance (- balance 1))))
    (when (> i index)
      (if (> (list-ref nums i) target)
          (set! balance (+ balance 1))
          (set! balance (- balance 1))))
    (when (= i index)
      (set! balance 0))
    (when (hash-has-key? cnt balance)
      (set! res (+ res (hash-ref cnt balance))))
    (hash-update! cnt balance add1 0))
  res)