#lang racket

(define (largest-magic-square grid)
  (define m (length grid))
  (define n (length (car grid)))
  (define (sum-row i j k)
    (for/sum ([x (in-range k)])
      (list-ref (list-ref grid (+ i x)) j)))
  (define (sum-col i j k)
    (for/sum ([x (in-range k)])
      (list-ref (list-ref grid i) (+ j x))))
  (define (sum-diag1 i j k)
    (for/sum ([x (in-range k)])
      (list-ref (list-ref grid (+ i x)) (+ j x))))
  (define (sum-diag2 i j k)
    (for/sum ([x (in-range k)])
      (list-ref (list-ref grid (+ i x)) (- (+ j k) x 1))))
  (define (is-magic i j k)
    (define s (sum-row i j k))
    (and (= s (sum-col i j k))
         (= s (sum-diag1 i j k))
         (= s (sum-diag2 i j k))))
  (define max-k 1)
  (for ([k (in-range (min m n) 1 -1)])
    (when (> k max-k)
      (for ([i (in-range (- m k 1))])
        (for ([j (in-range (- n k 1))])
          (when (is-magic i j k)
            (set! max-k k)
            (break)))))
    (when (> max-k 1)
      (break)))
  max-k)