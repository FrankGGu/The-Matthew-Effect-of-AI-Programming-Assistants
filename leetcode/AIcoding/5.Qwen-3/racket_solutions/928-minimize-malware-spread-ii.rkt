#lang racket

(define (min-malware-spread-ii is-connected malware)
  (define n (length is-connected))
  (define (bfs start)
    (define visited (make-vector n #f))
    (define q (queue '() '()))
    (vector-set! visited start #t)
    (queue-push! q start)
    (let loop ()
      (when (not (queue-empty? q))
        (define u (queue-pop! q))
        (for ([v (in-range n)])
          (when (and (vector-ref is-connected u) (vector-ref is-connected u v) (not (vector-ref visited v)))
            (vector-set! visited v #t)
            (queue-push! q v)))
        (loop))
    (for/sum ([i (in-range n)] #:when (vector-ref visited i)) 1))
  (define (count-infected m)
    (define visited (make-vector n #f))
    (define q (queue '() '()))
    (for-each (lambda (x) (vector-set! visited x #t) (queue-push! q x)) m)
    (let loop ()
      (when (not (queue-empty? q))
        (define u (queue-pop! q))
        (for ([v (in-range n)])
          (when (and (vector-ref is-connected u) (vector-ref is-connected u v) (not (vector-ref visited v)))
            (vector-set! visited v #t)
            (queue-push! q v)))
        (loop))
    (for/sum ([i (in-range n)] #:when (vector-ref visited i)) 1))
  (define (remove-malware m)
    (define new-malware (filter (lambda (x) (not (= x m))) malware))
    (if (null? new-malware)
        (bfs 0)
        (count-infected new-malware)))
  (define (min-value)
    (for/fold ([res +inf.0]) ([m malware])
      (min res (remove-malware m))))
  (min-value))