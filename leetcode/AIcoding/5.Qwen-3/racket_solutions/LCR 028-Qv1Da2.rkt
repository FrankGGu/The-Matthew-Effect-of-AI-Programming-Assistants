(define-struct node (val prev next children) #:mutable)

(define (flatten head)
  (define (dfs node)
    (when node
      (when (node-children node)
        (let* ((child (node-children node))
               (next (node-next node)))
          (set-node-next! node child)
          (set-node-prev! child node)
          (set-node-children! node #f)
          (let loop ((current child) (prev node))
            (when current
              (let ((next (node-next current)))
                (set-node-prev! current prev)
                (if (node-children current)
                    (let ((child (node-children current)))
                      (set-node-next! current child)
                      (set-node-prev! child current)
                      (set-node-children! current #f)
                      (loop child current))
                    (loop next current)))))))
      (dfs (node-next node))))
  (dfs head)
  head)