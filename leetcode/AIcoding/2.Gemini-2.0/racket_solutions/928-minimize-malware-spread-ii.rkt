(define (min-malware-spread-ii graph initial)
  (define n (vector-length graph))
  (define (dfs infected start)
    (define visited (make-vector n #f))
    (define stack (list start))
    (vector-set! visited start #t)
    (let loop ()
      (if (empty? stack)
          infected
          (let ((u (car stack)))
            (set! stack (cdr stack))
            (for/list ((v (in-range n)))
              (when (and (vector-ref (vector-ref graph u) v)
                         (not (vector-ref visited v)))
                (vector-set! visited v #t)
                (set! stack (cons v stack))))))))

  (define (count-saved node)
    (let* ((infected-without-node (filter (lambda (x) (not (= x node))) initial))
           (visited (make-vector n #f))
           (total-infected 0))
      (for ((start infected-without-node))
        (when (not (vector-ref visited start))
          (let ((reachable (dfs (vector-copy graph) start)))
            (for ((v reachable))
              (vector-set! visited v #t))
            (set! total-infected (+ total-infected (length reachable))))))
      (- n total-infected)))

  (define (compare a b)
    (cond ((> (count-saved a) (count-saved b)) a)
          ((= (count-saved a) (count-saved b)) (min a b))
          (else b)))

  (let ((result (apply min initial)))
    (for ((node (in-list initial)))
      (set! result (compare result node)))
    result))