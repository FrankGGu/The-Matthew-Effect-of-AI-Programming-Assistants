(struct RandomizedCollection (data idx) #:mutable)

(define (RandomizedCollection)
  (RandomizedCollection (vector) (hash)))

(define (insert! rc val)
  (let ((data (RandomizedCollection-data rc))
        (idx (RandomizedCollection-idx rc)))
    (vector-push! data val)
    (hash-update! idx val (lambda (old-idx) (cons (vector-length data) old-idx)) (list (vector-length data)))
    #t))

(define (remove! rc val)
  (let ((data (RandomizedCollection-data rc))
        (idx (RandomizedCollection-idx rc)))
    (if (hash-has-key? idx val)
        (let* ((indices (hash-ref idx val))
               (remove-idx (car indices))
               (last-idx (- (vector-length data) 1))
               (last-val (vector-ref data last-idx)))
          (vector-set! data remove-idx last-val)
          (vector-pop! data)
          (hash-update! idx val (lambda (old-idx) (cdr indices)) (list))
          (when (null? (hash-ref idx val))
            (hash-remove! idx val))
          (when (not (= remove-idx last-idx))
            (hash-update! idx last-val
                          (lambda (old-idx)
                            (let loop ((lst old-idx) (acc '()))
                              (cond
                                ((null? lst) acc)
                                ((= (car lst) last-idx) (cons remove-idx (append acc (cdr lst))))
                                (else (loop (cdr lst) (cons (car lst) acc))))))
                          (list)))
          #t)
        #f)))

(define (getRandom rc)
  (let ((data (RandomizedCollection-data rc)))
    (vector-ref data (random (vector-length data)))))