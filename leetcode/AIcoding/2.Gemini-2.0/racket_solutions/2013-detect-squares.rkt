(define (make-DetectSquares)
  (let ((points (make-hash)))
    (define (add point)
      (let ((x (car point))
            (y (cdr point)))
        (hash-update! points (cons x y) (lambda (v) (+ v 1)) 1)))
    (define (count point)
      (let ((x (car point))
            (y (cdr point)))
        (hash-ref points (cons x y) 0)))
    (define (count-squares point)
      (let ((x (car point))
            (y (cdr point)))
        (let loop ((squares 0)
                   (d 1))
          (cond
            ((> d 1000) squares)
            (else
             (let ((count-1 (* (hash-ref points (cons (+ x d) y) 0) (hash-ref points (cons x (+ y d)) 0)))
                   (count-2 (* (hash-ref points (cons (- x d) y) 0) (hash-ref points (cons x (+ y d)) 0)))
                   (count-3 (* (hash-ref points (cons (+ x d) y) 0) (hash-ref points (cons x (- y d)) 0)))
                   (count-4 (* (hash-ref points (cons (- x d) y) 0) (hash-ref points (cons x (- y d)) 0))))
               (loop (+ squares count-1 count-2 count-3 count-4) (+ d 1))))))))
    (define (dispatch method . args)
      (case method
        ((add) (apply add args))
        ((count) (apply count args))
        ((count-squares) (apply count-squares args))
        (else (error "Invalid method"))))
    dispatch))