(define (total-fruit fruits)
  (let* ((n (length fruits))
         (max-fruits 0))
    (for/fold ((left 0)
               (fruit-counts (hash))
               (curr-fruits 0))
              ((right (in-range n)))
      (let* ((fruit (list-ref fruits right))
             (new-fruit-counts (hash-update fruit fruit-counts (位 (x) (+ x 1)) 1))
             (num-unique-fruits (hash-count new-fruit-counts)))
        (if (<= num-unique-fruits 2)
            (values left new-fruit-counts (+ curr-fruits 1))
            (let loop ((l left)
                       (fc new-fruit-counts)
                       (cf curr-fruits))
              (let* ((left-fruit (list-ref fruits l))
                     (left-fruit-count (hash-ref fc left-fruit)))
                (if (> left-fruit-count 1)
                    (loop (+ l 1) (hash-update fc left-fruit (位 (x) (- x 1))) (- cf 1))
                    (values (+ l 1) (hash-remove fc left-fruit) (- cf 1))))))))
    (define (get-max-fruits left fruit-counts curr-fruits)
      (max max-fruits curr-fruits))

    (let loop ((right 0)
               (left 0)
               (fruit-counts (hash))
               (curr-fruits 0)
               (max-fruits 0))
      (if (= right n)
          max-fruits
          (let* ((fruit (list-ref fruits right))
                 (new-fruit-counts (hash-update fruit fruit-counts (位 (x) (+ x 1)) 1))
                 (num-unique-fruits (hash-count new-fruit-counts)))
            (if (<= num-unique-fruits 2)
                (loop (+ right 1) left new-fruit-counts (+ curr-fruits 1) (max max-fruits (+ curr-fruits 1)))
                (let loop2 ((l left)
                            (fc new-fruit-counts)
                            (cf curr-fruits))
                  (let* ((left-fruit (list-ref fruits l))
                         (left-fruit-count (hash-ref fc left-fruit)))
                    (if (> left-fruit-count 1)
                        (loop2 (+ l 1) (hash-update fc left-fruit (位 (x) (- x 1))) (- cf 1))
                        (loop (+ right 1) (+ l 1) (hash-remove fc left-fruit) (- cf 1) max-fruits)))))))))
    (loop 0 0 (hash) 0 0)))