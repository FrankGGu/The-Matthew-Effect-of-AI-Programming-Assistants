(define (median-finder)
  (let* ((min-heap (make-heap #:<=? >))
         (max-heap (make-heap #:<=? <))
         (add-num (lambda (num)
                     (heap-add! max-heap num)
                     (when (> (heap-count max-heap) 0)
                       (heap-add! min-heap (heap-remove-min! max-heap)))
                     (when (> (heap-count min-heap) (heap-count max-heap))
                       (heap-add! max-heap (heap-remove-min! min-heap)))))
         (find-median (lambda ()
                        (if (= (heap-count max-heap) (heap-count min-heap))
                            (/ (+ (heap-min max-heap) (heap-min min-heap)) 2.0)
                            (heap-min max-heap)))))
    (lambda (msg . args)
      (case msg
        ((addNum) (add-num (car args)))
        ((findMedian) (find-median))
        (else (error "Invalid message"))))))