(define (four-sum nums target)
  (let* ((n (length nums))
         (result '())
         (sorted-nums (sort nums <)))
    (for* ((i (in-range (- n 3)))
           #:when (or (= i 0) (not (= (list-ref sorted-nums i) (list-ref sorted-nums (- i 1)))))
           (j (in-range (+ i 1) (- n 2)))
           #:when (or (= j (+ i 1)) (not (= (list-ref sorted-nums j) (list-ref sorted-nums (- j 1)))))
           (left (+ j 1))
           (right (- n 1)))
      (let loop ()
        (cond
          ((> left right) void)
          ((= (+ (list-ref sorted-nums i) (list-ref sorted-nums j) (list-ref sorted-nums left) (list-ref sorted-nums right)) target)
           (set! result (cons (list (list-ref sorted-nums i) (list-ref sorted-nums j) (list-ref sorted-nums left) (list-ref sorted-nums right)) result))
           (let next-left ()
             (if (and (< left (- n 2)) (= (list-ref sorted-nums left) (list-ref sorted-nums (+ left 1))))
                 (begin (set! left (+ left 1)) (next-left))
                 (set! left (+ left 1))))
           (let next-right ()
             (if (and (> right (+ j 1)) (= (list-ref sorted-nums right) (list-ref sorted-nums (- right 1))))
                 (begin (set! right (- right 1)) (next-right))
                 (set! right (- right 1))))
           (loop))
          ((< (+ (list-ref sorted-nums i) (list-ref sorted-nums j) (list-ref sorted-nums left) (list-ref sorted-nums right)) target)
           (let next-left ()
             (if (and (< left (- n 2)) (= (list-ref sorted-nums left) (list-ref sorted-nums (+ left 1))))
                 (begin (set! left (+ left 1)) (next-left))
                 (set! left (+ left 1))))
           (loop))
          (else
           (let next-right ()
             (if (and (> right (+ j 1)) (= (list-ref sorted-nums right) (list-ref sorted-nums (- right 1))))
                 (begin (set! right (- right 1)) (next-right))
                 (set! right (- right 1))))
           (loop))))
    (remove-duplicates result equal?)))