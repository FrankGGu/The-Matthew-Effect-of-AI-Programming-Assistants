(define (construct grid)
  (define (all-same? grid)
    (if (null? grid)
        #t
        (let ((first-val (car (car grid))))
          (for/and ((row (in-list grid))
                    (val (in-list row)))
            (= val first-val)))))

  (define (build-node grid)
    (let ((n (length grid)))
      (if (all-same? grid)
          (make-quad-tree-node (car (car grid)) #t null null null null)
          (let* ((half-n (/ n 2))
                 (top-left (for/list ((i (in-range 0 half-n)))
                              (for/list ((j (in-range 0 half-n)))
                                (list-ref (list-ref grid i) j))))
                 (top-right (for/list ((i (in-range 0 half-n)))
                               (for/list ((j (in-range half-n n)))
                                 (list-ref (list-ref grid i) j))))
                 (bottom-left (for/list ((i (in-range half-n n)))
                                 (for/list ((j (in-range 0 half-n)))
                                   (list-ref (list-ref grid i) j))))
                 (bottom-right (for/list ((i (in-range half-n n)))
                                  (for/list ((j (in-range half-n n)))
                                    (list-ref (list-ref grid i) j)))))
            (make-quad-tree-node #f #f
                                 (build-node top-left)
                                 (build-node top-right)
                                 (build-node bottom-left)
                                 (build-node bottom-right))))))

  (build-node grid))