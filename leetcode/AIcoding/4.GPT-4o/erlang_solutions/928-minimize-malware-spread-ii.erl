-module(solution).
-export([min_malware_spread/2]).

min_malware_spread(Graph, Initial) ->
    N = length(Graph),
    InitialSorted = lists:sort(Initial),
    AdjacencyList = make_adjacency_list(Graph),
    MalwareCount = count_malware(AdjacencyList, InitialSorted),
    lists:foldl(fun(Node, Acc) -> min(Acc, dfs(Node, AdjacencyList, InitialSorted, MalwareCount)) end, infinity, InitialSorted).

make_adjacency_list(Graph) ->
    lists:map(fun(Row, I) -> lists:map(fun({J, Value}) -> {I, J} || Value == 1 end, lists:zip(lists:seq(0, length(Row) - 1), Row)) end,
        lists:zip(Graph, lists:seq(0, length(Graph) - 1))).

count_malware(AdjacencyList, Initial) ->
    lists:foldl(fun(Node, Acc) -> case lists:member(Node, Initial) of
        true -> Acc + 1;
        false -> Acc
    end end, 0, AdjacencyList).

dfs(Node, AdjacencyList, Initial, MalwareCount) ->
    {Visited, Count} = dfs_helper(Node, AdjacencyList, Initial, [], 0),
    if Count > 1 -> infinity; true -> Node
    end.

dfs_helper(Node, AdjacencyList, Initial, Visited, Count) ->
    case lists:member(Node, Visited) of
        true -> {Visited, Count};
        false ->
            NewVisited = [Node | Visited],
            NewCount = if lists:member(Node, Initial) -> Count + 1; true -> Count end,
            lists:foldl(fun({_, Next}, Acc) -> dfs_helper(Next, AdjacencyList, Initial, NewVisited, NewCount) end, {NewVisited, NewCount}, AdjacencyList)
    end.