(define (max-side-length mat threshold)
  (define n (length mat))
  (define m (length (car mat)))
  (define prefix-sum (make-vector (+ n 1) (make-vector (+ m 1) 0)))

    (for ([i (in-range n)])
      (for ([j (in-range m)])
        (vector-set! prefix-sum (+ i 1) (+ (vector-ref prefix-sum (+ i 1)) 
                                            (vector-ref (vector-ref mat i) j)))
        (vector-set! prefix-sum (+ i 1) 
                     (+ (vector-ref prefix-sum (+ i 1)) 
                        (vector-ref prefix-sum i)))))

    (define (get-sum x1 y1 x2 y2)
      (- (+ (vector-ref prefix-sum (+ x2 1)) 
             (vector-ref (vector-ref prefix-sum x1) y2))
         (vector-ref (vector-ref prefix-sum x1) y1)
         (vector-ref (vector-ref prefix-sum x2) y1)))

    (define max-side 0)
    (for ([size (in-range 1 (min (+ n 1) (+ m 1)))])
      (for ([i (in-range (- n size 1))])
        (for ([j (in-range (- m size 1))])
          (when (<= (get-sum i j (+ i size -1) (+ j size -1)) threshold)
            (set! max-side size)))))
    max-side))