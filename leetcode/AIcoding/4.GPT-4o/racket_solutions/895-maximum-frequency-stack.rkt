(define (max-frequency-stack)
  (define freq (make-hash))
  (define group (make-hash))
  (define max-freq 0)

  (define (push x)
    (define f (add1 (hash-ref freq x 0)))
    (hash-set! freq x f)
    (when (> f max-freq)
      (set! max-freq f))
    (when (not (hash-has-key? group f))
      (hash-set! group f (list)))
    (set! (hash-ref group f) (cons x (hash-ref group f))))

  (define (pop)
    (when (> max-freq 0)
      (define x (car (hash-ref group max-freq)))
      (set! (hash-ref group max-freq) (cdr (hash-ref group max-freq)))
      (hash-set! freq x (sub1 (hash-ref freq x)))
      (when (= (hash-ref freq x) 0)
        (hash-remove! freq x))
      (when (null? (hash-ref group max-freq))
        (hash-remove! group max-freq)
        (set! max-freq (sub1 max-freq)))
      x))

  (list push pop))