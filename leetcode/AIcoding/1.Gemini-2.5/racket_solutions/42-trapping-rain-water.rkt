(define (trap height)
  (let* ((n (length height))
         (height-vec (list->vector height)))
    (if (< n 3)
        0
        (let loop ((left 0)
                   (right (- n 1))
                   (left-max 0)
                   (right-max 0)
                   (total-water 0))
          (if (< left right)
              (let ((h-left (vector-ref height-vec left))
                    (h-right (vector-ref height-vec right)))
                (if (< h-left h-right)
                    (if (>= h-left left-max)
                        (loop (+ left 1) right h-left right-max total-water)
                        (loop (+ left 1) right left-max right-max (+ total-water (- left-max h-left))))
                    (if (>= h-right right-max)
                        (loop left (- right 1) left-max h-right total-water)
                        (loop left (- right 1) left-max right-max (+ total-water (- right-max h-right))))))
              total-water)))))