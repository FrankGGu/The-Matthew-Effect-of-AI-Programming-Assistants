(define (count-hidden-sequences diffs lower upper)
  (define (calculate-min-max-prefix-sum diffs)
    (let loop ((ds diffs)
               (current-sum 0)
               (min-so-far 0)
               (max-so-far 0))
      (if (empty? ds)
          (values min-so-far max-so-far)
          (let* ((d (car ds))
                 (next-sum (+ current-sum d))
                 (next-min (min min-so-far next-sum))
                 (next-max (max max-so-far next-sum)))
            (loop (cdr ds) next-sum next-min next-max)))))

  (let-values (((min-pref max-pref) (calculate-min-max-prefix-sum diffs)))
    (let ((range-pref (- max-pref min-pref)))
      (max 0 (+ (- upper lower range-pref) 1)))))